<!DOCTYPE html>
<html lang="zh-cmn-Hans"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Lofter jsbridge测试</title>
    <style>
        body {
            padding-bottom: 50px;
        }
        button {
            display: block;
            margin: 20px 0 0;
        }
    </style>
</head>
<body>
<script>document.write(navigator.userAgent);</script>
<div>如果有NEJSBridge的字样，就表示当前页会用NEJSBridge和app交互</div>
<div style="color:red">在android系统中，非njb_开头的接口，一律走老的接口，callHandler已做兼容处理，部分接口调用方式请参照demo使用</div>
<h2>Lofter app联调使用</h2>

<h2>分享</h2>
<button id="saveShareContent">设置分享内容</button><span>(商品详情页)</span>
<button id="showMenu">弹出分享组件</button>
<button id="njb_cbShareResult">设置分享回调</button>
<button id="hideActionMenu">隐藏当前webview的分享按钮</button><span>(下架商品)</span>
<button id="saveImage">下载图片到系统相册</button><span>(活动使用)</span>
<button id="njb_getDeviceInfo">获取系统信息</button><span>是否支持：<span id="njb_getDeviceInfo_support"></span></span>

<h2>主站</h2>
<button id="playBackgroundMusic">播放背景音乐</button><span>(活动使用)</span>
<h2>乐乎市集相关</h2>
<button id="pickAndUploadPhoto">从本地相册选择图片并上传</button><span>(评论)</span>
<button id="setLofterBackUrl1">设置路径回调（'url'）</button><span>(商品详情页)</span>
<button id="setLofterBackUrl2">设置路径回退到首页（'out'）</button><span>(首页)</span>
<button id="openSystemConfig">弹出弹窗，提示用户去开启系统通知</button><span>(商品购买成功后)</span>
<button id="isSupportWXPaySDK">询问客户端是否支持微信支付</button><span>(确认订单页)</span>
<button id="triggerLofterPaySDK">唤起支付</button><span>(确认订单页，立即购买页，待支付页)</span>
<button id="refreshMainPageWhenClose">标识关闭当前webview时刷新乐乎市集tab首页</button><span>(加入购物车页，确认订单页)</span>
<button id="cbPayResultFromApp">客户端完成支付操作后的回调处理</button><span>(确认订单页)</span>
<button id="updateCurrentUrl">货架页切换tab时候通知客户端最新的url</button><span>(货架页分享)</span>
<button id="setPageTitle">设置页面标题</button>

<h2>v7</h2>
<button id="njb_showWebviewHeader">显示头部导航栏</button>
<span>(默认显示，根据链接中njb_navigator字段，如果为false就不显示)</span>
<button id="njb_updateClient">更新客户端或跳转应用商店</button>
<span>(ios:跳APP Store。aos:android先会看有没有应用商店可以跳，如果没有的话就在应用内更新)</span>
<button id="njb_closeCurrentWebview">关闭当前webview</button>
<button id="njb_share">主动分享并设置该次调用的分享参数</button>
<span>(不展示复制链接、刷新一行)</span>
<button id="njb_getAppLog">获取客户端日志的nos链接</button><span>日志链接：<span id="njb_getAppLog_log"></span></span>
<button id="njb_providePullDownRefresh">提供下拉刷新</button>
<button id="njb_cbCloseWebview">用户自行关闭webview时调用js函数</button>

<h2>v8</h2>
<button id="njb_login">唤起登录</button>


<script>
    window.onerror = function(e, s, l, v) {
        alert(e.toString() + ' ' + s + ' ' + l + ' ' + v);
    };
</script>
<script src="//du.163.com/static/js/zepto.min.js"></script>
<!--<script src="https://easyreadfs.nosdn.127.net/1554204752556/bridge.lofter.iife.js"></script>-->
<!--<script src="//l.bst.126.net/rsc/js/nejsbridge/bridge.lofter.iife.js"></script>-->
<!--<script src="//easyreadfs.nosdn.127.net/fe/bridge.lofter.iife.04faceefed5bf1a62338d8d76b28cadf.js"></script>-->
<!--<script src="//easyreadfs.nosdn.127.net/fle/a0df1d4009c7a2ec5fee/1572246127720/bridge.lofter.iife.js"></script>-->
<!--<script src="//easyreadfs.nosdn.127.net/1580982937644/bridge.lofter.iife.js"></script>-->
<!--<script src="//easyreadfs.nosdn.127.net/fle/a0df1d4009c7a2ec5fee/1583723536106/bridge.lofter.iife.js"></script> v7-->
<script src="//easyreadfs.nosdn.127.net/fle/a0df1d4009c7a2ec5fee/1590224867497/bridge.lofter.iife.js"></script> <!--v8-->
<script src="https://hubble-js-bucket.nosdn.127.net/DATracker.sync.1.6.8.js"></script>
<script type="text/javascript">
    DATracker.init('MA-B4E8-3BEB9540671E', {use_app_track: true, truncateLength: 255});
</script>

<script>
    $(function() {
        var ua = window.navigator.userAgent,
          isAOS = /android/i.test(ua),
          isIOS = /iphone/i.test(ua);
        var callHandler = Bridge.lofter.callHandler;
        var registerHandler = Bridge.lofter.registerHandler;

        $('#saveShareContent').on('click', function() {
            var _shareCnt = {
                "id": 6002,
                "url": 'https://www.lofter.com',
                "content": {
                    "weiboImg": "https://imglf4.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mUmU3SXpWcjRUV1R3UVNyR2tMUm5xSEthNE15K1Q1MlBBPT0.jpg?imageView",
                    "weiboDesc": "帮我点赞，规则简单，你也一起来参加吧！戳>http://www.lofter.com",
                    "fImg": "https://imglf3.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mWlVPRVdMVTVGajRBMERUOGhtV05TTU11MnNES2VkTWlBPT0.jpg?imageView",
                    "fTitle": "我晒心头爱LOFTER来买单，快戳帮我赢1000元好物",
                    "fDesc": "这个价值1000元的东东我心水好久了，来帮我点赞，它就是我的",
                    "domains": [],
                    "lofterContent":{
                        "type": 3,
                        "lTitle":"我晒心头爱LOFTER来买单，快戳帮我赢1000元好物",
                        "lImg":"https://imglf4.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mUmU3SXpWcjRUV1R3UVNyR2tMUm5xSEthNE15K1Q1MlBBPT0.jpg?imageView",
                        "price":"¥15",
                        "ext":""
                    }
                }
            };

            if (window.navigator.userAgent.indexOf('android') >= 0) {
                // 安卓中需要stringify
                callHandler('saveShareContent', JSON.stringify(_shareCnt));
            } else {
                // ios 不需要
                callHandler('saveShareContent', _shareCnt);
            }
        })

        $('#showMenu').on('click', function() {
            callHandler('showMenu');
        })
        $('#njb_cbShareResult').on('click', function() {
            //客户端分享之后回调处理
            registerHandler('njb_cbShareResult', function(data) {
                if (data.code === 0) {
                    alert('分享成功')
                } else {
                    alert('分享失败')
                }
            });
            alert('分享回调已注册，分享回来看到分享结果')
        })




        $('#hideActionMenu').on('click', function() {
            callHandler('hideActionMenu');
        })


        $('#saveImage').on('click', function() {
            callHandler('saveImage', {
                url: 'http://imglf4.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mUmU3SXpWcjRUV1R3UVNyR2tMUm5xSEthNE15K1Q1MlBBPT0.jpg?imageView',
                data: ''
            });
        })

        $('#njb_getDeviceInfo').on('click', function() {
            callHandler('njb_getDeviceInfo', {}, function (data) {
                alert(JSON.stringify(data))
            });
        })

        $('#njb_getDeviceInfo_support')[0].innerHTML = Bridge.lofter.support('njb_getDeviceInfo') ? '是' : '否';

        $('#pickAndUploadPhoto').on('click', function() {
            var _data = JSON.stringify({maxsize:1080});
            callHandler('pickAndUploadPhoto', _data);
        })

        //客户端图片上传完成后的回调处理
        registerHandler('cbImgUploaded', function(data) {
            var _res = JSON.parse(data);
            if(_res.status == 200) {
                var _imgurl = _res.result + '?imageView';
                alert(_imgurl);
            }
        });


        $('#playBackgroundMusic').on('click', function() {
            registerHandler('playBackgroundMusic', function() {
                alert('取得音频节点，启动播放');
                //var audio = document.getElementsByTagName('audio')[0];
                //audio.load();
                //audio.play();
            });
        });

        $('#setLofterBackUrl1').on('click', function() {
            var _url = 'http://www.lofter.com/benefit/main/entry';
            callHandler('setLofterBackUrl', _url);
        })

        $('#setLofterBackUrl2').on('click', function() {
            callHandler('setLofterBackUrl', 'out');
        })

        $('#openSystemConfig').on('click', function() {
            callHandler('openSystemConfig');
        })

        $('#refreshMainPageWhenClose').on('click', function() {
            callHandler('refreshMainPageWhenClose');
        })

        $('#isSupportWXPaySDK').on('click', function() {
            callHandler('isSupportWXPaySDK', null, function (_isSupportWXPaySDK) {
                alert(_isSupportWXPaySDK);
            });
        })

        $('#triggerLofterPaySDK').on('click', function() {
            var _zhifujson = "_input_charset=\"UTF-8\"&body=\"lost8范围商品\"&it_b_pay=\"10m\"&notify_url=\"http://paygate.163.com//callback/orderBack/AlipayAII/UTF-8/2014032519PT02593073/2014032519PT02593073\"&out_trade_no=\"PGTZ037T190404TLB2017023\"&partrier=\"2088121255108001\"&payment_type=\"1\"&paymethod=\"directPay\"&seller_id=\"2088121255108001\"&service=\"mobile.securitypay.pay\"&sign=\"gTkrnTWyl14A npOGAAbE418F2C nbQkKT0qhiBEha6EgcQckdtKdJGI2mNWN9tEcvhl32Jfwq0bHvvRjNMF6kP3On Hd6iqRQT83c9wJ7ZC24vWuLLi6PrAKjpSZG4ghWnXgvzH9iuXDYf%2BD1SQWmjP1qQKAMP7%2F%2FXfjVdvT nwn%2Fo%3D\"&sign_type=\"RSA\"&subject=\"lost8 范围商品\"&total_fee=\"0.01\""
            var _data = {type:0,params:_zhifujson};
            var _zhifumap = JSON.stringify(_data);
            callHandler('triggerLofterPaySDK',_zhifumap);
        })

        registerHandler('cbPayResultFromApp', function(data) {
            alert(JSON.stringify(data));
        });

        $('#cbPayResultFromApp').on('click', function() {
            alert('唤起支付后回到本页可看到数据弹窗');
        })

        $('#updateCurrentUrl').on('click', function() {
            var _url = 'https://www.lofter.com/market/fe/home/homePage.html';
            callHandler('updateCurrentUrl',_url);
        })

        $('#setPageTitle').on('click', function() {
            var _title = '修改标题';
            callHandler('njb_setPageTitle',{
                title: _title
            });
        })
        $('#njb_login').on('click', function() {
            callHandler('njb_login',{}, function (data) {
                if (data.code === 200) {
                    alert('登录成功')
                } else {
                    alert('登录失败')
                }
            });
        })
        $('#njb_showWebviewHeader').on('click', function() {
            var href = location.href;
            if (href.indexOf('njb_navigator') > -1) {
                location.href = href.split('?')[0];
            } else {
                location.href = href + '?njb_navigator=false';
            }
        })
        $('#njb_updateClient').on('click', function() {
            callHandler('njb_updateClient');
        })
        $('#njb_closeCurrentWebview').on('click', function() {
            callHandler('njb_closeCurrentWebview');
        })
        $('#njb_share').on('click', function() {
            var _shareCnt = {
                "id": 6002,
                "url": 'https://www.lofter.com',
                "content": {
                    "weiboImg": "https://imglf4.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mUmU3SXpWcjRUV1R3UVNyR2tMUm5xSEthNE15K1Q1MlBBPT0.jpg?imageView",
                    "weiboDesc": "帮我点赞，规则简单，你也一起来参加吧！戳>http://www.lofter.com",
                    "fImg": "https://imglf3.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mWlVPRVdMVTVGajRBMERUOGhtV05TTU11MnNES2VkTWlBPT0.jpg?imageView",
                    "fTitle": "我晒心头爱LOFTER来买单，快戳帮我赢1000元好物",
                    "fDesc": "这个价值1000元的东东我心水好久了，来帮我点赞，它就是我的",
                    "domains": [],
                    "lofterContent":{
                        "lTitle":"我晒心头爱LOFTER来买单，快戳帮我赢1000元好物",
                        "lImg":"https://imglf4.nosdn.127.net/img/ODlFV2dPWEVGc3pxdldwa000RW5mUmU3SXpWcjRUV1R3UVNyR2tMUm5xSEthNE15K1Q1MlBBPT0.jpg?imageView",
                        "price":15,
                        "ext":""
                    }
                }
            };

            callHandler('njb_share', {
                shareCnt:_shareCnt
            });
        })
        $('#njb_getAppLog').on('click', function() {
            callHandler('njb_getAppLog', {}, function (data) {
                $('#njb_getAppLog_log')[0].innerHTML = data.url;
            });
        })
        $('#njb_providePullDownRefresh').on('click', function() {
            callHandler('njb_providePullDownRefresh',{
                provide: true
            });
        })
        $('#njb_cbCloseWebview').on('click', function() {
            //客户端分享之后回调处理
            registerHandler('njb_cbCloseWebview', function() {
                DATracker.track('w9-9',{category:'jsbridgeTestPage'});
                alert('即将关闭Webview')
            });
            alert('已注册事件，关闭Webview试试')
        })
    })

</script>

</body></html>